<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plant Doctor â€” Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">ðŸŒ¿ Plant Doctor</h1>
      <nav class="text-sm">
        <a href="/" class="text-slate-500 hover:text-slate-900 mr-4">Home</a>
        <a href="/docs" class="text-slate-500 hover:text-slate-900">API Docs</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white shadow-sm rounded-2xl p-4">
        <div class="text-sm text-slate-500">Model</div>
        <div class="text-xl font-semibold mt-1" id="stat-model">plant_doctor.pt</div>
        <div class="text-xs text-slate-400 mt-1" id="stat-classes-count">â€”</div>
      </div>
      <div class="bg-white shadow-sm rounded-2xl p-4">
        <div class="text-sm text-slate-500">Classes</div>
        <div class="mt-2 flex flex-wrap gap-2 text-sm" id="stat-classes">
          <!-- chips inserted here -->
        </div>
      </div>
      <div class="bg-white shadow-sm rounded-2xl p-4">
        <div class="text-sm text-slate-500">Tips</div>
        <ul class="list-disc list-inside text-sm mt-2 text-slate-600">
          <li>Upload a leaf image to diagnose.</li>
          <li>Ask the chatbot for treatments.</li>
          <li>Use clear, close-up photos.</li>
        </ul>
      </div>
    </section>

    <!-- Diagnose + Result -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Upload card -->
      <div class="bg-white shadow-sm rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Diagnose a Leaf</h2>
        <div class="space-y-3">
          <input id="file" type="file" accept="image/*"
                 class="block w-full text-sm text-slate-700 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100"/>
          <button id="btn-diagnose"
                  class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">
            Diagnose
          </button>
          <div id="preview" class="mt-2 hidden">
            <div class="text-xs text-slate-500 mb-1">Preview</div>
            <img id="preview-img" class="w-full rounded-xl border border-slate-200"/>
          </div>
        </div>
        <div id="diag-status" class="mt-3 text-sm text-slate-500"></div>
      </div>

      <!-- Results card -->
      <div class="bg-white shadow-sm rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Result</h2>
        <div id="result" class="space-y-3 text-sm">
          <div><span class="text-slate-500">Prediction:</span> <span id="res-pred" class="font-semibold">â€”</span></div>
          <div><span class="text-slate-500">Confidence:</span> <span id="res-conf" class="font-semibold">â€”</span></div>
          <div><span class="text-slate-500">Top-3:</span> <span id="res-top3" class="font-mono">â€”</span></div>
          <div><span class="text-slate-500">Source:</span> <span id="res-source" class="font-semibold">â€”</span></div>
          <div>
            <div class="text-slate-500">Treatment:</div>
            <pre id="res-treat" class="mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl overflow-auto whitespace-pre-wrap">â€”</pre>
          </div>
          <div id="heat-wrap" class="hidden">
            <div class="text-slate-500">Grad-CAM Heatmap:</div>
            <img id="res-heat" class="mt-2 w-full rounded-xl border border-slate-200"/>
          </div>
        </div>
      </div>
    </section>

    <!-- Chatbot -->
    <section class="bg-white shadow-sm rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-3">RAG Chatbot</h2>
      <div class="flex gap-2">
        <input id="chat-input" type="text" placeholder="e.g., how to treat tomato late blight?"
               class="flex-1 rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
        <button id="btn-chat"
                class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900 disabled:opacity-50">Ask
        </button>
      </div>
      <div id="chat-out" class="mt-3 text-sm">
        <div class="text-slate-500">Answer:</div>
        <div id="chat-answer" class="mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl whitespace-pre-wrap">â€”</div>
        <div class="mt-1 text-xs text-slate-500">Source: <span id="chat-source">â€”</span></div>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">
    Built with FastAPI Â· PyTorch Â· RAG Â· Grad-CAM
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    // ----- Stats -----
    async function loadStats() {
      try {
        const r = await fetch('/stats');
        const j = await r.json();
        $('stat-model').textContent = j.model || 'plant_doctor.pt';
        $('stat-classes-count').textContent = `${(j.classes || []).length} classes`;
        const wrap = $('stat-classes');
        wrap.innerHTML = '';
        (j.classes || []).forEach(c => {
          const chip = document.createElement('span');
          chip.className = 'inline-block px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100';
          chip.textContent = c;
          wrap.appendChild(chip);
        });
      } catch (e) {}
    }

    // ----- Preview -----
    $('file').addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        $('preview-img').src = reader.result;
        $('preview').classList.remove('hidden');
      };
      reader.readAsDataURL(f);
    });

    // ----- Diagnose -----
    $('btn-diagnose').onclick = async () => {
      const f = $('file').files[0];
      if (!f) return alert('Choose an image');
      $('btn-diagnose').disabled = true;
      $('diag-status').textContent = 'Diagnosingâ€¦';

      const fd = new FormData();
      fd.append('file', f);
      const r = await fetch('/predict', { method: 'POST', body: fd });
      const j = await r.json();

      $('res-pred').textContent = j.prediction ?? 'â€”';
      $('res-conf').textContent = (j.confidence != null) ? j.confidence.toFixed(3) : 'â€”';
      $('res-source').textContent = j.source || 'â€”';
      $('res-treat').textContent = j.treatment_plan || 'â€”';

      if (j.top3 && j.top3.length) {
        $('res-top3').textContent = j.top3.map(t => `${t.label}:${t.prob.toFixed(3)}`).join('  ');
      } else {
        $('res-top3').textContent = 'â€”';
      }

      if (j.heatmap_image_b64) {
        $('res-heat').src = 'data:image/png;base64,' + j.heatmap_image_b64;
        $('heat-wrap').classList.remove('hidden');
      } else {
        $('heat-wrap').classList.add('hidden');
      }

      $('diag-status').textContent = 'Done.';
      $('btn-diagnose').disabled = false;
    };

    // ----- Chat -----
    $('btn-chat').onclick = async () => {
      const q = $('chat-input').value.trim();
      if (!q) return;
      $('btn-chat').disabled = true;
      $('chat-answer').textContent = 'Thinkingâ€¦';

      const r = await fetch('/chat?query=' + encodeURIComponent(q), { method:'POST' });
      const j = await r.json();
      $('chat-answer').textContent = j.answer || 'No info found.';
      $('chat-source').textContent = j.source || 'â€”';
      $('btn-chat').disabled = false;
    };

    loadStats();
  </script>
</body>
</html>
